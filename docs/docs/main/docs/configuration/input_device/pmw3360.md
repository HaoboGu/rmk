# PMW3360 Optical Mouse Sensor

PMW3360 is a optical mouse sensor.

::: note

- PMW3360 uses full-duplex SPI. (MISO/ MOSI)
- `motion` pin is optional. If omitted, the sensor is polled.
- Only Nrf and RP2040 are supported now. TODO: Find out which boards work, actually every board with an SPIBus implementation should

:::

## `toml` configuration

::: warning

:::

```toml
[[input_device.pmw3360]]
name = "trackball0"

spi.instance = "spi0"
spi.sck = "PIN18"
spi.mosi = "PIN19"
spi.miso = "PIN16"
spi.tx_dma = "DMA_CH2"
spi.rx_dma = "DMA_CH3"

cs = "PIN17"
motion = "PIN20" # Optional. If omitted, the sensor is polled.

cpi = 1600
rot_trans_angle: -15
liftoff_dist: 8
invert_x = true
# invert_y = true
# swap_xy = true
```

## Rust configuration

Define `Pmw3360Device` and add it to `run_devices!` macro.

```rust
    use embassy_rp::spi::{Spi, Config, Polarity, Phase};
    use embassy_rp::gpio::Output;
    use rmk::input_device::pmw3360::{Pmw3360Config, Pmw3360Device};
    use embassy_rp::gpio::{Level, Pull};

    let mut spi_cfg = Config::default();
    // // MODE_3 = Polarity::IdleHigh + Phase::CaptureOnSecondTransition
    spi_cfg.polarity = Polarity::IdleHigh;
    spi_cfg.phase = Phase::CaptureOnSecondTransition;
    spi_cfg.frequency = 2_000_000;

    // // Create GPIO pins
    let pmw3360_sck = p.PIN_18;
    let pmw3360_mosi = p.PIN_19;
    let pmw3360_miso = p.PIN_16;
    let pmw3360_cs = Output::new(p.PIN_17, Level::High);
    let pmw3360_irq = Input::new(p.PIN_20, Pull::Up);

    // Create the SPI bus
    let pmw3360_spi = Spi::new(p.SPI0, pmw3360_sck,pmw3360_mosi,pmw3360_miso, p.DMA_CH2, p.DMA_CH3, spi_cfg);

    // Initialize PMW3360 mouse sensor
    let pmw3360_config = Pmw3360Config {
        res_cpi: 1600,
        rot_trans_angle: -15,
        liftoff_dist: 0x08,
        swap_xy: false,
        invert_x: true,
        invert_y: false,
        ..Default::default()
    };

    // Create the sensor device
    let mut pmw3360_device = Pmw3360Device::new(
        pmw3360_spi, pmw3360_cs, Some(pmw3360_irq), pmw3360_config);
```

And define a `Pmw3610Processor` and add it to `run_processor_chain!` macro to process the events.
The `Pmw3610Processor` can be used for the PMW3360 just as well. 

::: warning

This should be added to the central if the sensor is on split peripheral.

:::

```rust
    use rmk::input_device::pmw3610::Pmw3610Processor;

    let mut pmw3360_processor = Pmw3610Processor::new(&keymap);

    run_processor_chain! {
        EVENT_CHANNEL => [pmw3360_processor],
    },
```

